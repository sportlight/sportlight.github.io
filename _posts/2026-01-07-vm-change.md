# 살얼음판 위를 걷는 기분: 레거시 시스템을 무중단으로 VM 이관하기 (feat. 배치와 파일 동기화)

개발자라면 누구나 **"잘 돌아가고 있는 레거시 시스템을 건드리는 공포"**를 한 번쯤 느껴보셨을 겁니다. 건드리면 터질 것 같고, 안 건드리자니 인프라 노후화가 걱정되는 상황이죠.

최근 저는 물리 서버에서 운영되던 **Apple 서비스 통합 시스템(예약, 수리, 자재 관리)**을 신규 가상화(VM) 환경으로 이관하는 작업을 진행했습니다. 단순한 '서버 이동'처럼 보였지만, 실상은 6종의 복잡한 배치 작업과 실시간 파일 동기화, 그리고 무중단 배포라는 요구사항이 얽힌 고난이도 미션이었습니다.

오늘은 이 살얼음판 같았던 이관 과정에서 겪은 **'배치 중복 실행 문제'**와 **'데이터 동기화 딜레마'**를 어떻게 기술적/절차적으로 해결했는지 공유하려 합니다.

---

## 1. 배경: 왜 이관해야 했나?

기존 시스템은 예약 접수부터 자재 관리(MAS), 태블릿 앱(App)까지 비즈니스의 핵심 로직이 집약된 모놀리식 구조였습니다. 물리 서버의 노후화로 인해 유연한 자원 관리가 가능한 VM 환경으로의 전환이 결정되었습니다.

하지만 이 시스템에는 치명적인 **제약 사항**들이 있었습니다.

* **⚠️ 복잡한 배치(Batch) 스케줄:** SMS 발송(5초 주기), 재고 동기화, 그리고 5년치 데이터를 정리하는 1시간짜리 대형 배치가 얽혀 있습니다.
* **⚠️ 실시간 파일 생성:** 고객이 수리 접수를 하는 순간 PDF와 이미지가 생성됩니다. 단 하나의 파일 유실도 허용되지 않습니다.
* **⚠️ Zero Downtime:** 대고객 서비스이므로 IP 교체(Cutover) 순간에도 서비스 중단이 없어야 합니다.

---

## 2. 난관: 우리를 괴롭힌 두 가지 문제

이관 시나리오를 짜면서 마주친 가장 큰 기술적 난관은 두 가지였습니다.

### 문제 1. 배치가 두 번 돌면 망한다 (Dual-Run Hazard)
기존 운영 서버와 신규 VM 서버가 병렬로 떠 있는 과도기(Transition Period)에, **양쪽에서 동시에 배치가 실행되는 상황**입니다.
* 고객에게 SMS가 두 번 발송됨
* DB에 Lock이 이중으로 걸려 Deadlock 발생
* 데이터 정합성 파괴

### 문제 2. 파일 동기화의 역설 (Rsync Dilemma)
보통 파일 동기화는 `운영(Source) -> VM(Target)` 방향으로 흐릅니다. 하지만 테스트 기간 동안 테스터들이 **VM 서버에서 새로운 파일(수리 증빙 이미지 등)을 생성**하게 됩니다.
오픈 직전 최신 데이터를 맞추기 위해 다시 `rsync`를 돌리면, **VM에서 생성된 소중한 테스트 데이터가 운영 서버 기준으로 덮어써지거나 삭제(`--delete`)될 위험**이 있었습니다.

---

## 3. 전략: 리스크를 0으로 수렴시키는 4단계 파이프라인

한 번에 모든 것을 넘기는 '빅뱅' 방식은 너무 위험했습니다. 우리는 1월 5일부터 9일까지, 트래픽과 배치 실행 권한을 아주 잘게 쪼개어 이관하는 **4단계 전략**을 수립했습니다.

```mermaid
graph LR
    Step1[Step 1: 웹 검증] --> Step2[Step 2: 하이브리드 운영]
    Step2 --> Step3[Step 3: 배치 권한 이양]
    Step3 --> Step4[Step 4: 최종 Cutover]
    
    style Step3 fill:#f96,stroke:#333,stroke-width:4px
    style Step4 fill:#90EE90,stroke:#333,stroke-width:2px
